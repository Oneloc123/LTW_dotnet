
@model WebApplication1.Models.LoginViewModel
@{
    ViewBag.Title = "Đăng nhập";
}
@* <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"> *@

<div id="login-container">
    @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "loginForm", @class = "needs-validation", novalidate = "novalidate" }))
    {
        <div class="form-group mb-3">
            @Html.LabelFor(m => m.Username, new { @class = "form-label fw-bold" })
            @Html.TextBoxFor(m => m.Username, new {
            @class = "form-control form-control-lg",
                placeholder = "Nhập tên đăng nhập",
                autocomplete = "username",
                required = "required"
                })
        <div class="invalid-feedback" id="username-error">
            @Html.ValidationMessageFor(m => m.Username)
        </div>
    </div>

    <div class="form-group mb-4">
        @Html.LabelFor(m => m.Password, new { @class = "form-label fw-bold" })
        @Html.PasswordFor(m => m.Password, new {
                @class = "form-control form-control-lg",
                placeholder = "Nhập mật khẩu",
                autocomplete = "current-password",
                required = "required"
                })
        <div class="invalid-feedback" id="password-error">
            @Html.ValidationMessageFor(m => m.Password)
        </div>
    </div>

    <div class="d-grid gap-2 mb-3">
        <button type="submit" class="btn btn-primary btn-lg" id="loginBtn">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="loadingSpinner"></span>
            <span id="btnText">Đăng nhập</span>
        </button>
    </div>

    <div class="alert d-none" id="messageAlert" role="alert"></div>

    @Html.ValidationSummary(true, "", new { @class = "alert alert-danger", id = "validationSummary" })
        }
</div>

<!-- Modal Thành công -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Thành công</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Đăng nhập thành công!</p>
                <p>Đang chuyển hướng...</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Xử lý submit form với Ajax
            $('#loginForm').submit(function (e) {
                e.preventDefault();

                // Reset trạng thái
                resetValidation();

                // Hiển thị loading
                showLoading(true);

                // Lấy dữ liệu form
                var formData = {
                    Username: $('#Username').val(),
                    Password: $('#Password').val(),
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                };

                // Gửi request Ajax
                $.ajax({
                    url: '@Url.Action("LoginAjax", "Account")',
                    type: 'POST',
                    data: formData,
                    dataType: 'json',
                    success: function (response) {
                        showLoading(false);

                        if (response.success) {
                            // Hiển thị modal thành công
                            $('#successModal').modal('show');

                            // Chuyển hướng sau 2 giây
                            setTimeout(function () {
                                window.location.href = response.redirectUrl || '/Home';
                            }, 2000);
                        } else {
                            // Hiển thị lỗi
                            showError(response.message || 'Đăng nhập thất bại');

                            // Hiển thị lỗi validation nếu có
                            if (response.errors) {
                                displayValidationErrors(response.errors);
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        showLoading(false);
                        showError('Có lỗi xảy ra. Vui lòng thử lại sau.');
                        console.error('Login error:', error);
                    }
                });
            });

            // Xóa thông báo lỗi khi người dùng bắt đầu nhập
            $('#Username, #Password').on('input', function () {
                $(this).removeClass('is-invalid');
                $('#messageAlert').addClass('d-none');
                $('#validationSummary').addClass('d-none').html('');
            });

            // Hàm hiển thị loading
            function showLoading(isLoading) {
                if (isLoading) {
                    $('#loadingSpinner').removeClass('d-none');
                    $('#btnText').text('Đang xử lý...');
                    $('#loginBtn').prop('disabled', true);
                } else {
                    $('#loadingSpinner').addClass('d-none');
                    $('#btnText').text('Đăng nhập');
                    $('#loginBtn').prop('disabled', false);
                }
            }

            // Hàm hiển thị lỗi
            function showError(message) {
                var alert = $('#messageAlert');
                alert.removeClass('d-none alert-success').addClass('alert-danger');
                alert.html('<i class="bi bi-exclamation-triangle me-2"></i>' + message);
                alert[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Hàm hiển thị lỗi validation
            function displayValidationErrors(errors) {
                if (errors.Username) {
                    $('#Username').addClass('is-invalid');
                    $('#username-error').html(errors.Username.join('<br>'));
                }

                if (errors.Password) {
                    $('#Password').addClass('is-invalid');
                    $('#password-error').html(errors.Password.join('<br>'));
                }

                // Hiển thị validation summary
                if (Object.keys(errors).length > 0) {
                    var summaryHtml = '';
                    for (var key in errors) {
                        if (errors.hasOwnProperty(key)) {
                            summaryHtml += '<li>' + errors[key].join('<br>') + '</li>';
                        }
                    }
                    $('#validationSummary').html('<ul class="mb-0">' + summaryHtml + '</ul>').removeClass('d-none');
                }
            }

            // Hàm reset validation
            function resetValidation() {
                $('.form-control').removeClass('is-invalid');
                $('.invalid-feedback').html('');
                $('#messageAlert').addClass('d-none');
                $('#validationSummary').addClass('d-none').html('');
            }
        });
        // Xử lý quên mật khẩu
                $('#forgotPasswordBtn').click(function() {
            var email = $('#Username').val();

            if (!email) {
                showError('Vui lòng nhập email để khôi phục mật khẩu');
                return;
            }

            $.ajax({
                url: '@Url.Action("ForgotPassword", "Account")',
                type: 'POST',
                data: { email: email },
                success: function(response) {
                    if (response.success) {
                        showSuccess('Đã gửi hướng dẫn khôi phục mật khẩu qua email');
                    } else {
                        showError(response.message);
                    }
                }
            });
        });
                // Hiển thị/ẩn mật khẩu
        $('.password-field').append(
            '<button type="button" class="btn btn-outline-secondary position-absolute end-0 top-0" id="togglePassword">' +
            '<i class="bi bi-eye"></i>' +
            '</button>'
        );

        $('#togglePassword').click(function() {
            var passwordField = $('#Password');
            var type = passwordField.attr('type') === 'password' ? 'text' : 'password';
            passwordField.attr('type', type);
            $(this).find('i').toggleClass('bi-eye bi-eye-slash');
        });

                // Validate username khi rời khỏi field
        $('#Username').on('blur', function() {
            var username = $(this).val();
            if (username.length > 0 && username.length < 3) {
                showFieldError('Username', 'Tên đăng nhập phải có ít nhất 3 ký tự');
            }
        });

        // Validate password strength
        $('#Password').on('keyup', function() {
            var password = $(this).val();
            var strength = checkPasswordStrength(password);
            updatePasswordStrength(strength);
        });

        function checkPasswordStrength(password) {
            var strength = 0;
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            return strength;
        }
    </script>

    <style>
        #login-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .form-control-lg {
            padding: 12px 15px;
            font-size: 16px;
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: 18px;
            font-weight: 600;
        }

        #messageAlert {
            transition: all 0.3s ease;
        }

        .spinner-border {
            vertical-align: middle;
            margin-right: 8px;
        }

        .form-label {
            color: #495057;
            margin-bottom: 8px;
        }

        .invalid-feedback {
            display: block;
        }
    </style>
}