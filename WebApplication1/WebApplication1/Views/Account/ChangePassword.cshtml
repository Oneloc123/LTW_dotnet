
@model WebApplication1.Models.ChangePasswordViewModel   

@{
    ViewBag.Title = "Đổi mật khẩu";
}

<div class="change-password-container">
    <div class="card shadow-lg">
        <div class="card-header bg-warning text-white">
            <h2 class="mb-0"><i class="fas fa-key me-2"></i>Đổi mật khẩu</h2>
        </div>
        
        <div class="card-body">
            <div id="messageContainer" class="d-none"></div>
            
            <form id="changePasswordForm" method="post" novalidate>
                @Html.AntiForgeryToken()
                
                <div class="mb-3">
                    <label for="OldPassword" class="form-label fw-bold">
                        <i class="fas fa-lock me-1"></i>@Html.DisplayNameFor(m => m.OldPassword)
                    </label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-key"></i></span>
                        @Html.PasswordFor(m => m.OldPassword, new { 
                            @class = "form-control form-control-lg",
                            placeholder = "Nhập mật khẩu hiện tại",
                            autocomplete = "current-password"
                        })
                        <button type="button" class="btn btn-outline-secondary toggle-password" data-target="#OldPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback d-block">
                        @Html.ValidationMessageFor(m => m.OldPassword)
                    </div>
                </div>

                <div class="mb-3">
                    <label for="NewPassword" class="form-label fw-bold">
                        <i class="fas fa-lock me-1"></i>@Html.DisplayNameFor(m => m.NewPassword)
                    </label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                        @Html.PasswordFor(m => m.NewPassword, new { 
                            @class = "form-control form-control-lg",
                            placeholder = "Nhập mật khẩu mới (ít nhất 6 ký tự)",
                            autocomplete = "new-password"
                        })
                        <button type="button" class="btn btn-outline-secondary toggle-password" data-target="#NewPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback d-block">
                        @Html.ValidationMessageFor(m => m.NewPassword)
                    </div>
                    <div class="progress mt-2" style="height: 5px;">
                        <div id="passwordStrength" class="progress-bar" role="progressbar"></div>
                    </div>
                    <small class="text-muted mt-1 d-block" id="passwordStrengthText">Độ mạnh mật khẩu</small>
                </div>

                <div class="mb-4">
                    <label for="ConfirmNewPassword" class="form-label fw-bold">
                        <i class="fas fa-lock me-1"></i>@Html.DisplayNameFor(m => m.ConfirmNewPassword)
                    </label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-check-circle"></i></span>
                        @Html.PasswordFor(m => m.ConfirmNewPassword, new { 
                            @class = "form-control form-control-lg",
                            placeholder = "Nhập lại mật khẩu mới",
                            autocomplete = "new-password"
                        })
                        <button type="button" class="btn btn-outline-secondary toggle-password" data-target="#ConfirmNewPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback d-block">
                        @Html.ValidationMessageFor(m => m.ConfirmNewPassword)
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" id="submitBtn" class="btn btn-warning btn-lg">
                        <span id="submitText">
                            <i class="fas fa-sync-alt me-2"></i>Cập nhật mật khẩu
                        </span>
                        <span id="loadingSpinner" class="d-none">
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            Đang xử lý...
                        </span>
                    </button>
                    
                    <button type="button" id="resetBtn" class="btn btn-outline-secondary">
                        <i class="fas fa-redo me-2"></i>Nhập lại
                    </button>
                </div>
            </form>
        </div>
        
        <div class="card-footer bg-light">
            <div class="password-tips">
                <h6 class="fw-bold"><i class="fas fa-lightbulb me-1"></i>Mẹo mật khẩu an toàn:</h6>
                <ul class="list-unstyled mb-0 small">
                    <li><i class="fas fa-check text-success me-1"></i>Ít nhất 6 ký tự</li>
                    <li><i class="fas fa-check text-success me-1"></i>Kết hợp chữ hoa và chữ thường</li>
                    <li><i class="fas fa-check text-success me-1"></i>Bao gồm số và ký tự đặc biệt</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @* @Scripts.Render("~/bundles/jqueryval") *@
    
    <script>
        $(document).ready(function() {
            // Toggle hiển thị mật khẩu
            $('.toggle-password').click(function() {
                const target = $(this).data('target');
                const input = $(target);
                const icon = $(this).find('i');
                
                if (input.attr('type') === 'password') {
                    input.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    input.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });

            // Kiểm tra độ mạnh mật khẩu
            $('#NewPassword').on('input', function() {
                checkPasswordStrength($(this).val());
                validateConfirmPassword();
            });

            // Kiểm tra xác nhận mật khẩu
            $('#ConfirmNewPassword').on('input', validateConfirmPassword);

            // Nút reset
            $('#resetBtn').click(function() {
                $('#changePasswordForm')[0].reset();
                $('#messageContainer').addClass('d-none');
                $('#passwordStrength').css('width', '0%').removeClass('bg-danger bg-warning bg-success');
                $('#passwordStrengthText').text('Độ mạnh mật khẩu');
                $('.invalid-feedback').empty();
                $('.form-control').removeClass('is-invalid');
            });

            // Xử lý submit form với Ajax
            $('#changePasswordForm').submit(function(e) {
                e.preventDefault();
                
                if (!$(this).valid()) {
                    showMessage('Vui lòng kiểm tra lại thông tin', 'danger');
                    return;
                }

                const submitBtn = $('#submitBtn');
                const submitText = $('#submitText');
                const loadingSpinner = $('#loadingSpinner');
                
                // Hiển thị trạng thái loading
                submitBtn.prop('disabled', true);
                submitText.addClass('d-none');
                loadingSpinner.removeClass('d-none');

                // Gửi request Ajax
                $.ajax({
                    url: '@Url.Action("ChangePassword", "Account")',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, 'success');
                            $('#changePasswordForm')[0].reset();
                            $('#passwordStrength').css('width', '0%').removeClass('bg-danger bg-warning bg-success');
                            $('#passwordStrengthText').text('Độ mạnh mật khẩu');
                        } else {
                            showMessage(response.message, 'danger');
                            
                            // Hiển thị lỗi chi tiết nếu có
                            if (response.errors && response.errors.length > 0) {
                                let errorHtml = '<ul>';
                                response.errors.forEach(function(error) {
                                    errorHtml += `<li>${error}</li>`;
                                });
                                errorHtml += '</ul>';
                                showMessage(errorHtml, 'danger');
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        showMessage('Có lỗi kết nối đến máy chủ. Vui lòng thử lại sau.', 'danger');
                    },
                    complete: function() {
                        // Ẩn trạng thái loading
                        submitBtn.prop('disabled', false);
                        submitText.removeClass('d-none');
                        loadingSpinner.addClass('d-none');
                    }
                });
            });

            function checkPasswordStrength(password) {
                let strength = 0;
                
                if (password.length >= 6) strength++;
                if (/[a-z]/.test(password)) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                const strengthBar = $('#passwordStrength');
                const strengthText = $('#passwordStrengthText');
                
                let width = 0;
                let color = '';
                let text = '';
                
                switch(strength) {
                    case 0:
                    case 1:
                        width = 20;
                        color = 'bg-danger';
                        text = 'Rất yếu';
                        break;
                    case 2:
                        width = 40;
                        color = 'bg-danger';
                        text = 'Yếu';
                        break;
                    case 3:
                        width = 60;
                        color = 'bg-warning';
                        text = 'Trung bình';
                        break;
                    case 4:
                        width = 80;
                        color = 'bg-success';
                        text = 'Mạnh';
                        break;
                    case 5:
                        width = 100;
                        color = 'bg-success';
                        text = 'Rất mạnh';
                        break;
                }
                
                strengthBar.css('width', width + '%');
                strengthBar.removeClass('bg-danger bg-warning bg-success').addClass(color);
                strengthText.text(`Độ mạnh mật khẩu: ${text}`);
            }

            function validateConfirmPassword() {
                const newPassword = $('#NewPassword').val();
                const confirmPassword = $('#ConfirmNewPassword').val();
                const confirmInput = $('#ConfirmNewPassword');
                
                if (confirmPassword === '') return;
                
                if (newPassword !== confirmPassword) {
                    confirmInput.addClass('is-invalid');
                    confirmInput.nextAll('.invalid-feedback').html('Mật khẩu xác nhận không khớp');
                } else {
                    confirmInput.removeClass('is-invalid');
                    confirmInput.nextAll('.invalid-feedback').empty();
                }
            }

            function showMessage(message, type) {
                const messageContainer = $('#messageContainer');
                const alertClass = `alert-${type}`;
                
                messageContainer.removeClass('d-none alert-success alert-danger alert-warning')
                               .addClass(`alert ${alertClass}`)
                               .html(`
                    <div class="d-flex align-items-center">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>
                        <div>${message}</div>
                    </div>
                `);
                
                // Tự động ẩn thông báo sau 5 giây
                if (type === 'success') {
                    setTimeout(() => {
                        messageContainer.fadeOut(300, function() {
                            $(this).addClass('d-none').removeAttr('style');
                        });
                    }, 5000);
                }
            }
        });
    </script>
}

<style>
    .change-password-container {
        max-width: 500px;
        margin: 2rem auto;
        padding: 0 15px;
    }
    
    .card {
        border-radius: 15px;
        border: none;
    }
    
    .card-header {
        border-radius: 15px 15px 0 0 !important;
        padding: 1.2rem 1.5rem;
    }
    
    .card-body {
        padding: 2rem;
    }
    
    .card-footer {
        border-radius: 0 0 15px 15px !important;
        padding: 1.2rem 1.5rem;
    }
    
    .input-group-text {
        background-color: #f8f9fa;
        border-right: none;
    }
    
    .form-control:focus {
        box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
        border-color: #ffc107;
    }
    
    .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-warning:hover {
        background-color: #e0a800;
        border-color: #d39e00;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }
    
    .password-tips {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
    }
    
    .toggle-password {
        border-left: none;
    }
    
    .toggle-password:hover {
        background-color: #e9ecef;
    }
    
    .progress {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .progress-bar {
        transition: width 0.5s ease;
    }
    
    .alert {
        border-radius: 10px;
        border: none;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        color: #495057;
        margin-bottom: 0.5rem;
    }
</style>